<Window x:Class="LargeFolderFinder.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:LargeFolderFinder"
        mc:Ignorable="d"
        Title="Large Folder Finder" Height="800" Width="1200"
        MinWidth="400" MinHeight="300"
        Background="#F5F5F7">
    
    <DockPanel>
        <!-- Menu Bar (Common) -->
        <Menu DockPanel.Dock="Top">
            <MenuItem x:Name="MenuFile" Header="ファイル(_F)">
                <MenuItem x:Name="MenuRestartAdmin" Header="管理者として開き直す(_A)" Click="MenuRestartAdmin_Click"/>
                <Separator/>
                <MenuItem x:Name="MenuExit" Header="終了(_X)" Click="MenuExit_Click"/>
            </MenuItem>
            <MenuItem x:Name="MenuView" Header="表示(_V)" SubmenuOpened="MenuView_SubmenuOpened">
                <MenuItem x:Name="MenuLanguage" Header="Language(_L)"/>
                <MenuItem x:Name="MenuLayout" Header="レイアウト(_L)">
                    <MenuItem x:Name="MenuLayoutVertical" Header="縦並び(_V)" Click="MenuLayoutVertical_Click" IsCheckable="True"/>
                    <MenuItem x:Name="MenuLayoutHorizontal" Header="横並び(_H)" Click="MenuLayoutHorizontal_Click" IsCheckable="True"/>
                </MenuItem>
                <MenuItem x:Name="MenuOpenConfig" Header="設定を開く(_S)" Click="Config_Click"/>
                <MenuItem x:Name="MenuOpenLogSub" Header="ログを開く(_O)"/>
            </MenuItem>
            <MenuItem x:Name="MenuHelp" Header="ヘルプ(_H)">
                <MenuItem x:Name="MenuOpenReadme" Header="Readme を開く(_R)" Click="MenuReadme_Click"/>
                <MenuItem x:Name="MenuLicense" Header="ライセンス(_L)">
                    <MenuItem x:Name="MenuAppLicense" Header="アプリのライセンス(_A)" Click="MenuAppLicense_Click"/>
                    <MenuItem x:Name="MenuThirdPartyLicenses" Header="サードパーティライセンス(_T)" Click="MenuThirdPartyLicenses_Click"/>
                </MenuItem>
                <Separator/>
                <MenuItem x:Name="MenuAbout" Header="バージョン情報(_A)" Click="MenuAbout_Click"/>
            </MenuItem>
        </Menu>

        <!-- Global Header (Path, Scan, etc.) -->
        <Grid DockPanel.Dock="Bottom" Margin="10,10,10,0">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>
            <TextBox x:Name="pathTextBox" Grid.Column="0" Height="26" VerticalContentAlignment="Center" Margin="0,0,1,0" KeyDown="Input_KeyDown" />
            <Button x:Name="browseButton" Grid.Column="1" Content="..." Width="40" Height="26" Click="BrowseButton_Click" />

            <!-- Scan buttons -->
            <Button x:Name="scanButton" Grid.Column="2" ToolTip="Scan" Width="50" Height="25" FontWeight="Bold" Background="#0078D7" Foreground="White" Margin="10,0,0,0" Click="ScanButton_Click">
                <Path Data="{StaticResource RunIconGeometry}" Fill="White" Stretch="Uniform" Margin="6" />
            </Button>
            <!-- Cancel buttons -->
            <Button x:Name="cancelButton" Grid.Column="3" Width="50" Height="25" IsEnabled="False" Margin="5,0,0,0" Click="CancelButton_Click" ToolTip="Cancel">
                <Path Data="{StaticResource StopIconGeometry}" Fill="#444" Stretch="Uniform" Margin="6" />
            </Button>
            <!-- Config buttons -->
            <Button x:Name="configButton" Grid.Column="4" Width="25" Height="25" Margin="5,0,0,0" Click="Config_Click" ToolTip="Settings">
                <Path Data="{StaticResource ConfigIconGeometry}" Fill="#444" Stretch="Uniform" Margin="5" />
            </Button>
        </Grid>

        <!-- Tab Control -->
        <Grid Margin="5">
            <TabControl x:Name="SessionTabControl" 
                        ItemsSource="{Binding Sessions}" 
                        SelectedIndex="{Binding SelectedIndex}"
                        SelectionChanged="SessionTabControl_SelectionChanged"
                        Background="Transparent"
                        BorderThickness="0">
                <TabControl.Resources>
                    <Style TargetType="TabItem">
                        <Setter Property="Background" Value="#F0F0F0"/>
                        <Setter Property="BorderBrush" Value="#CCC"/>
                        <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                        <Setter Property="VerticalContentAlignment" Value="Stretch"/>
                        
                        <!-- Override Template to respect Background property -->
                        <Setter Property="Template">
                            <Setter.Value>
                                <ControlTemplate TargetType="TabItem">
                                    <Border x:Name="Bd"
                                            Background="{TemplateBinding Background}"
                                            BorderBrush="{TemplateBinding BorderBrush}"
                                            BorderThickness="1,1,1,0"
                                            CornerRadius="4,4,0,0"
                                            Padding="6,2">
                                        <ContentPresenter x:Name="Content" 
                                                          ContentSource="Header" 
                                                          HorizontalAlignment="{Binding HorizontalContentAlignment, RelativeSource={RelativeSource AncestorType={x:Type ItemsControl}}}" 
                                                          VerticalAlignment="{Binding VerticalContentAlignment, RelativeSource={RelativeSource AncestorType={x:Type ItemsControl}}}" 
                                                          RecognizesAccessKey="True"/>
                                    </Border>
                                    <ControlTemplate.Triggers>
                                        <Trigger Property="IsSelected" Value="True">
                                            <Setter TargetName="Bd" Property="Margin" Value="-2,-2,-2,-1"/>
                                            <Setter TargetName="Bd" Property="Panel.ZIndex" Value="1"/>
                                        </Trigger>
                                        <Trigger Property="IsSelected" Value="False">
                                            <Setter TargetName="Bd" Property="Margin" Value="0,0,0,0"/>
                                        </Trigger>
                                    </ControlTemplate.Triggers>
                                </ControlTemplate>
                            </Setter.Value>
                        </Setter>

                        <Style.Triggers>
                            <!-- Priority 1: Selected (Normal) -->
                            <Trigger Property="IsSelected" Value="True">
                                <Setter Property="Background" Value="White"/>
                            </Trigger>
                            
                            <!-- Priority 2: Old Data (Inactive) -->
                            <DataTrigger Binding="{Binding IsOldData}" Value="True">
                                <Setter Property="Background" Value="#fdfd9e"/>
                            </DataTrigger>
                            
                            <!-- Priority 3: Old Data (Active) -->
                            <MultiDataTrigger>
                                <MultiDataTrigger.Conditions>
                                    <Condition Binding="{Binding IsSelected, RelativeSource={RelativeSource Self}}" Value="True"/>
                                    <Condition Binding="{Binding IsOldData}" Value="True"/>
                                </MultiDataTrigger.Conditions>
                                <Setter Property="Background" Value="#fcfca1"/>
                            </MultiDataTrigger>
                        </Style.Triggers>
                    </Style>
                    
                    <!-- Style for Close Button -->
                    <Style x:Key="TabCloseButtonStyle" TargetType="Button">
                        <Setter Property="RenderOptions.BitmapScalingMode" Value="NearestNeighbor"/>
                        <Setter Property="Width" Value="16"/>
                        <Setter Property="Height" Value="16"/>
                        <Setter Property="BorderThickness" Value="0"/>
                        <Setter Property="Background" Value="Transparent"/>
                        <Setter Property="Margin" Value="5,0,0,0"/>
                        <Setter Property="Template">
                            <Setter.Value>
                                <ControlTemplate TargetType="Button">
                                    <Border Background="{TemplateBinding Background}" CornerRadius="2">
                                        <Path Data="M0,0 L8,8 M8,0 L0,8" Stroke="#666" StrokeThickness="1.5" VerticalAlignment="Center" HorizontalAlignment="Center"/>
                                    </Border>
                                    <ControlTemplate.Triggers>
                                        <Trigger Property="IsMouseOver" Value="True">
                                            <Setter Property="Background" Value="#DDD"/>
                                        </Trigger>
                                    </ControlTemplate.Triggers>
                                </ControlTemplate>
                            </Setter.Value>
                        </Setter>
                    </Style>
                </TabControl.Resources>

                <!-- ItemsPanel for Left Aligned Tabs -->
                <TabControl.ItemsPanel>
                    <ItemsPanelTemplate>
                        <StackPanel Orientation="Horizontal" IsItemsHost="True"/>
                    </ItemsPanelTemplate>
                </TabControl.ItemsPanel>

                <!-- Template to add button next to tabs -->
                <TabControl.Template>
                    <ControlTemplate TargetType="TabControl">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>
                            <!-- Tab Header Area -->
                            <Border Grid.Row="0" BorderThickness="0,0,0,1" BorderBrush="#CCC">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/> <!-- Tabs -->
                                        <ColumnDefinition Width="Auto"/> <!-- Add Button -->
                                        <ColumnDefinition Width="*"/>    <!-- Rest -->
                                    </Grid.ColumnDefinitions>
                                    <TabPanel x:Name="HeaderPanel" Grid.Column="0" Panel.ZIndex="1" IsItemsHost="True" 
                                              Margin="2,2,0,0" Background="Transparent"/>
                                    
                                    <!-- Add Tab Button (Next to Tabs) -->
                                    <Button x:Name="AddTabButton" Grid.Column="1" VerticalAlignment="Bottom" Margin="2,0,0,2" Width="24" Height="24" 
                                            Click="AddTabButton_Click" ToolTip="New Tab (Max 10)" Background="Transparent" BorderThickness="0">
                                        <Path Data="M4,0 L4,8 M0,4 L8,4" Stroke="#444" StrokeThickness="1.5" Margin="4" VerticalAlignment="Center" HorizontalAlignment="Center"/>
                                    </Button>
                                </Grid>
                            </Border>
                            
                            <!-- Tab Content -->
                            <ContentPresenter x:Name="PART_SelectedContentHost" Grid.Row="1" ContentSource="SelectedContent" Margin="0"/>
                        </Grid>
                    </ControlTemplate>
                </TabControl.Template>
                
                <!-- Header Template (Title + Close Button) -->
                <TabControl.ItemTemplate>
                    <DataTemplate>
                        <Grid MinWidth="80" MaxWidth="250" ToolTip="{Binding TabTooltip}">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <TextBlock Grid.Column="0" Text="{Binding TabTitle}" 
                                       VerticalAlignment="Center" 
                                       HorizontalAlignment="Left"
                                       TextTrimming="CharacterEllipsis"
                                       Margin="0,0,2,0"/>
                            <Button Grid.Column="1" Style="{StaticResource TabCloseButtonStyle}" Click="TabCloseButton_Click" Tag="{Binding}"/>
                        </Grid>
                    </DataTemplate>
                </TabControl.ItemTemplate>

                <!-- Content Template (The Result View) -->
                <TabControl.ContentTemplate>
                    <DataTemplate>
                        <Border BorderBrush="#CCC" BorderThickness="1" Padding="0" Background="White">
                           <ContentControl Content="{Binding CurrentView}"/>
                        </Border>
                    </DataTemplate>
                </TabControl.ContentTemplate>
            </TabControl>
        </Grid>
    </DockPanel>
</Window>
